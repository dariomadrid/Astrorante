---
import {
  api,
  getPages,
  getPosts,
  getSettings,
  getPage,
} from "@util/storyblokApi";
import StoryblokComponent from "@storyblok/astro/StoryblokComponent.astro";
import Layout from "@layouts/Layout.astro";
import { translateUrl } from "@util/translate";
import { SITE_LANG } from "astro:env/server";

export async function getStaticPaths() {
    try {
        const { data } = (await api.get("cdn/spaces/me", {})) as SpaceObj;
        const locales = [SITE_LANG, ...data.space.language_codes];

        /* GET ALL PAGES AND POSTS IN ALL LANGUAGES (Corrected) */
        const allPagesAndPosts = []; // Array to hold all pages and posts

        for (const lang of locales) { // Use a loop to process each language sequentially
            const dataLang = lang === SITE_LANG ? "default" : lang; // Corrected conditional

            const settings = await getSettings(lang);

            const pages = await getPages(
                dataLang,
                import.meta.env.DEV ? "draft" : "published",
                settings,
                locales
            );

            const posts = await getPosts( // Corrected variable name
                dataLang,
                import.meta.env.DEV ? "draft" : "published",
                settings,
                locales
            );

            allPagesAndPosts.push(...pages, ...posts); // Add to the array
        }

        return allPagesAndPosts; // Return the combined array

    } catch (e) {
        console.error("Error in getStaticPaths:", e); // More informative error message

        return [ // Return a default path in case of error
            {
                params: {
                    slug: undefined,
                },
            },
        ];
    }
}

let { settings, story, locales } = Astro.props;

if (!settings) {
  return Astro.redirect("/setup");
}

const status = import.meta.env.DEV ? "draft" : "published";

if (import.meta.env.DEV) {
  /* LOOK FOR CONTENT UPDATES IN DEV MODE */
  const { slug, lang } = Astro.props as RouteParams;

  try {
    settings = await getSettings(lang);
    story = await getPage(slug, lang);
  } catch (e) {
    console.log("error", e);
  }
}

const { og_title, og_description, og_image } = story;
const localeUrls = translateUrl(Astro.url, locales || [SITE_LANG]);

const meta = {
  title: og_title || "404",
  description: og_description || "page not found",
  og_image: "",
  image: og_image?.filename || "",
};
---

<Layout meta={meta} {settings} {localeUrls}>
  <StoryblokComponent blok={story} {status} />
</Layout>
